<!DOCTYPE html>
<html 
xmlns:th="http://www.thymeleaf.org"
xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" 
layout:decorate="~{fragments/layout/layout.html}">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <title>타이틀</title>
</head>
<body>
<main layout:fragment="content">
  <div class="container">
    <div class="row text-center">
      <div class="col-1 border">1</div>
      <div class="col-1 border">2</div>
      <div class="col-1 border">3</div>
      <div class="col-1 border">4</div>
      <div class="col-1 border">5</div>
      <div class="col-1 bg-warning border">6</div>
      <div class="col-1 bg-warning border">7</div>
      <div class="col-1 border">8</div>
      <div class="col-1 border">9</div>
      <div class="col-1 border">10</div>
      <div class="col-1 border">11</div>
      <div class="col-1 border">12</div>
    </div>
  </div>
  <div class="bg-white border-bottom py-2 d-flex justify-content-center gap-4 small fw-semibold">
    <div> <span class="text-dark">국내</span> <span class="text-muted">· 장 닫힘</span> </div>
    <div> <span class="text-dark">해외</span> <span class="text-muted">· 장 닫힘</span> </div>
  </div>
<div class="container mt-4">
  <div class="row gx-5">
    <!-- 왼쪽 콘텐츠 -->
    <div class="col-lg-9">
      <div class="container">
        <div th:if="${krwTotal != null}">
          <div style="display: flex; justify-content: center; gap: 40px; margin-top: 40px; ">
            <div style="width: 400px">
              <canvas id="typeChart"></canvas>
            </div>
            <div style="width: 400px">
              <canvas id="assetChart"></canvas>
            </div>
          </div>
        </div>
      </div>
      <!-- 데이터가 있을 경우만 테이블 보여줌 -->
      <div th:if="${not #lists.isEmpty(comparisonList)}">
        <table class="table mt-4">
          <thead>
            <tr>
              <th>자산</th>
              <th>통화</th>
              <th>현재 비중</th>
              <th>목표 비중</th>
              <th>차이</th>
            </tr>
          </thead>
          <tbody>
            <tr th:each="row : ${comparisonList}">
              <td th:text="${row.as_asset_type}"></td>
              <td th:text="${row.as_currency}"></td>
              <td th:text="${row.current_percent + '%'}"></td>
              <td th:text="${row.ta_target_percent + '%'}"></td>
              <td th:text="${row.gap_percent > 0 ? '+' + row.gap_percent + '%' : row.gap_percent + '%'}"></td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="d-flex justify-content-center">
        <div class="text-center text-danger fw-bold">
          여기에 요약해서 알려줌 가장 많이 벗어난 순으로 % 출력
        </div>
      </div>
      <!-- 데이터 없을 경우 경고 출력 -->
      <div th:if="${#lists.isEmpty(comparisonList)}" class="alert alert-warning text-center">
        아직 등록된 리밸런싱 목표가 없거나 자산 데이터가 없습니다.
      </div>

  </div>
  <!-- 오른쪽 사이드 패널 -->
  <div class="col-lg-2 border-start ps-4">
    <!-- 🔹 지수 타이틀 박스 -->
    <div class="bg-light px-3 py-2 rounded-pill" style="display: inline-block;">
      <h6 class="text-muted mb-0">지수</h6>
  </div>
  
  <!-- 🔹 지표 리스트 영역 -->
  <div class="pt-2">
    <div class="d-flex justify-content-between">
      <div class="text-muted">환율</div>
      <span class="text-danger">2,626.87</span>
    </div>
    <div class="d-flex justify-content-between">
      <div class="text-muted">나스닥 🔺</div>
      <span class="text-danger">2,626.87</span>
    </div>
    <div class="d-flex justify-content-between">
      <div class="text-muted">S&P 500</div>
      <span class="text-danger">2,626.87</span>
    </div>
    <div class="d-flex justify-content-between">
      <div class="text-muted">VIX 🔻</div>
      <span class="text-danger">2,626.87</span>
    </div>
  </div>
</div>
</main>
<th:block layout:fragment="script">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <script th:inline="javascript">
    Chart.register(ChartDataLabels);
    const krwTotal = [[${krwTotal}]];         // 예: 6915
    const usdTotal = [[${usdTotal}]];         // 예: 8
    const exchangeRate = [[${exchangeRate}]]; // 예: 1375.39
    const usdToWon = usdTotal * exchangeRate;

    const data = {
      labels: ['KRW 비중', 'USD 비중'],
      datasets: [{
        label: '자산 비중',
        data: [krwTotal, usdToWon],
        backgroundColor: ['#36A2EB', '#4BC0C0'],
        hoverOffset: 25
      }]
    };

    const config = {
      type: 'doughnut',
      data: data,
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'bottom' },
          title: {
            display: true,
            text: '자산 비중 비교하기',
            font: {
              size: 24,
              weight: 'bold'
            },
            padding: {
              top: 20,
              bottom: 10
            }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const label = context.label;
                const value = context.raw;
                const formatted = Math.round(value).toLocaleString('ko-KR');
                return `${label}: ${formatted} 원`;
              }
            }
          },
          datalabels: {
            color: '#fff',
            font: {
              weight: 'bold',
              size: 28
            },
            formatter: (value, context) => {
              const total = context.chart._metasets[0].total;
              const percent = Math.round((value / total) * 100);
              return percent + '%';
            }
          }
        }
      },
      plugins: [ChartDataLabels]
    };
    // 새 차트
    new Chart(document.getElementById('assetChart'), config);
    const typeLabels = /*[[${typeLabels}]]*/ [];
    const typeValues = /*[[${typeValues}]]*/ [];
    const typeAmounts = /*[[${typeAmounts}]]*/ [];
    const typeCurrencies = /*[[${typeCurrencies}]]*/ [];
    const typeData = {
      labels: typeLabels,
      datasets: [{
        data: typeValues, // 금액 원본
        backgroundColor: [
          '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'
        ],
        hoverOffset: 25
      }]
    };

      const typeConfig = {
      type: 'doughnut',
      data: typeData,
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'bottom' },
          title: {
            display: true,
            text: '자산 유형별 비중',
            font: { size: 24, weight: 'bold' }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const label = context.label;
                const idx = context.dataIndex;
                const amount = typeAmounts[idx];
                const currency = typeCurrencies[idx];
                const formatted = Math.round(amount).toLocaleString('ko-KR');
                const unit = currency === 'USD' ? '달러' : '원';
                return `${label}: ${formatted} ${unit}`;
              }
            }
          }
          ,
          datalabels: {
            color: '#fff',
            font: { size: 18, weight: 'bold' },
            formatter: function(value, context) {
              const total = context.chart._metasets[0].total;
              const percent = (value / total) * 100;
              return percent.toFixed(1) + '%';
            }
          }
        }
      },
      plugins: [ChartDataLabels]
    };
    new Chart(document.getElementById('typeChart'), typeConfig);
  </script>
</th:block>
</body>
</html>